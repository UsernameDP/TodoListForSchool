<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="CSS/general.css">
    <link rel="stylesheet" href="CSS/header.css">
    <link rel= "stylesheet" href = "CSS/class.css">
    <link rel="stylesheet" href="CSS/TodosAssessment.css">
    <title>School Todo List</title>
</head>
<body>
    <!-- Header/Nav Bar -->
    <nav class="header">
        <p>A Todo List For School</p>
        <button id="class_main_open_button" onclick = class_main_open()>Clases</button>
    </nav>

    <!-- Classes -->
    <main id="class_main">
        <div class="opacity"></div>
        <sub id="class_sub" class="class_sub">
            <!-- Header -->
            <ClassHeader>
                Classes
            </ClassHeader>
            <!-- Textboxes for Input -->
            <class_inputs>
                <input type="text" id="class_period">
                <input type="text" id="class_name">
                <button id="class_addButton" onclick= add_Classes()>Add</button>
            </class_inputs>
            <class_append_location id="class_append_location"></class_append_location>
            <button id="Class_Close" onclick=close_class_main()>Close</button>
        </sub>
    </main>

    <!-- Todos And Assessments -->
    <main id="display_main" class="display_main"></main>

    <AddTodo id="display_todo_info_input">
        <input type="text" id="display_todo_text">
        <input type="date"id="display_todo_date">
        <button id="display_todo_values" onclick=display_add_todo()>Done</button>
    </AddTodo>


    <!-- Variable Def Organization(Classes) -->
    <script type="text/javascript" src="JS/class.js"></script>
    <script type="text/javascript" src="JS/TodoAssessment.js"></script>

    <!-- Main Script -->
    <script>
        //Declared Variables
        let class_list;
        let todo_list;
       
        //Upload Saved Data
        const saved_class_list = JSON.parse(localStorage.getItem('class'));
        const saved_todo_list = JSON.parse(localStorage.getItem('Todo'));

            //What to do with saved_class_list
        if (Array.isArray(saved_class_list)){
            class_list = saved_class_list;
        }
        else{
            class_list = [];
        }
        if (Array.isArray(saved_todo_list)){
            todo_list = saved_todo_list;
        }
        else{
            todo_list = [];
        }
        
        //Settings to call by Default
        default_settings();
        class_render();
        display_class_render();
        display_render_todos();
        
        //Default Setting Functions
        function default_settings(){
            class_main.style.display = "none";
            display_todo_info_input.style.display = "none";
        }
        

        //Function to Save Data
        function save_data(){
            localStorage.setItem('class', JSON.stringify(class_list))
            localStorage.setItem('Todo', JSON.stringify(todo_list))
        }




        //Class Assosiation Section

            //class_main opens(display => flex)
        function class_main_open(){
            class_main.style.display = "flex";
        }
            //Classes and Blank List for Todos are added to class_list
        function add_Classes(){
            const period = class_period.value;
            const name = class_name.value;
                    //skips if there is nothing in period of name
            if (period == ""){
                return
            }
            else if(name == ""){
                return
            }
            //Prevents having two of the same Period
            for (let x in class_list){
                if (class_list[x].period == period){
                    console.log("YOU CAN'T HAVE TWO OF THE SAME PERIOD GOSH DARN IT");
                    return
                }
            }

                    //Adds Classes to a List
            class_list.push({
                period: period,
                name: name,
            })
            sort_class();
            class_render();

                //Finding the index of the same period once sorted
            const find_period_loc = (subject) => subject.period == period;
            const period_loc = class_list.findIndex(find_period_loc);
                //Adding the blank list at the same index once list was sorted
            todo_list.splice(period_loc,0,[]);            

            display_class_render();
            save_data();
        }
            //Sorts the Classes in the class_list by period #
        function sort_class(){
            class_list.sort(function (subjectA, subjectB){
                return subjectA.period - subjectB.period;
            })
        }
            //Render the Class
        function class_render(){
            class_append_location.innerHTML = '';
            let id_index = 0;
            class_list.forEach(function (subject){
                //This will Tie the class_list to todo_list when a subject is removed
                //Also resets the ID every time thing function is ran
                Object.assign(subject, {id: id_index});      

                    //Div to store the Class Information in
                const element = document.createElement("div");
                element.setAttribute('id', "Subject"+id_index);
                element.innerText = "Period:" + subject.period + "\n" + "Subject: " + subject.name + "\n";
                class_append_location.appendChild(element);

                    //Button To remove A class
                const button = document.createElement("button");
                button.innerText = "Remove";
                button.id = "Class_Remove_Button" + id_index;
                button.onclick = remove_class
                document.getElementById("Subject" + id_index).appendChild(button);

                id_index += 1;
            })
        }
            //Removes the Class and FINALLY...Also removes the respective todo_list
        function remove_class(){
            const targetID = parseInt(event.target.id.split("Class_Remove_Button")[1]);
            
            class_list = class_list.filter((subject) =>{
                if (subject.id == targetID){
                    const find_loc_id = (element) => element.id == subject.id
                    const loc_id = class_list.findIndex(find_loc_id);
                    todo_list.splice(loc_id, 1);
                    return false
                }
                else if(subject.id != targetID){
                    return true
                }
            })
            class_render();
            display_class_render()
            save_data();
        }
        function close_class_main(){
            class_main.style.display = "none";
        }
        
        //Displaying Todo and Assessment Section

        function display_class_render(){
            display_main.innerHTML = '';

            class_list.forEach((subject) =>{
                const display_div = document.createElement("div");
                display_div.setAttribute('id', "display_class" + subject.id);
                display_div.innerText = subject.period + subject.name;
                display_div.style.backgroundColor = "red";
                display_main.appendChild(display_div);

                const todo_div = document.createElement("div");
                todo_div.innerText = "Todo";
                todo_div.setAttribute('id', "display_todo_loc" + subject.id);
                document.getElementById("display_class"+subject.id).appendChild(todo_div);

                const todo_button = document.createElement("button");
                todo_button.innerText = "Add";
                todo_button.onclick = display_todo_div_values
                todo_button.setAttribute('id', "display_todo_button" + subject.id);
                document.getElementById("display_class"+subject.id).appendChild(todo_button);
            })
        }

        function display_todo_div_values(){
            const loc_id = event.target.id.split("display_todo_button")[1];
            display_todo_info_input.style.display = "flex";
            document.getElementById("display_todo_loc"+loc_id).appendChild(display_todo_info_input);            
        }

        function display_add_todo(){
            //change this later if you are planning to change the location to put the todos
            const loc_id = event.target.parentNode.parentNode.id.split("display_todo_loc")[1];
            
            //Values from Input Elements
            const todo = display_todo_text.value;
            let date = display_todo_date.value;
            date = date.split("-");
            date = new Date(date[0], date[1], date[2]);

            //Can use the year,month, and day to re-define date in render if localstorage breaks it
            //And..Yep we have to do that, define date using the months every time you render
            todo_list[loc_id].push({
                todo: todo,
                year: date.getFullYear(),
                month: date.getMonth(),
                day: date.getDate(),
            })
            
            //Note that this list is probably not sorted at this stage
            display_render_todos();
            save_data();
        }

        //Renders the todos to the page, adds date, and sets id per todo
    function display_render_todos(){
        let index = 0;
        todo_list.forEach(function (list){
            const element = document.getElementById("display_todo_loc" + index);
            element.innerHTML = '';
            index += 1;
        })

        //Assign Date and Todo Number with respect to its location
        let todo_list_index = 0;
        let todo_index = 0;
        todo_list.forEach(function (list){
            list.forEach(function (todo){
                const date = new Date(todo.year, todo.month, todo.day);
                const id = "todo" + todo_index + "loc"+todo_list_index
                Object.assign(todo, {date: date});
                Object.assign(todo, {id: id});
                todo_index += 1
            })
            
            display_todo_sort(todo_list[todo_list_index]);
            todo_list_index += 1
        })
        save_data();

        todo_list_index = 0;
        todo_index = 0;
        todo_list.forEach(function (list){
            list.forEach(function (object){
                const location = document.getElementById("display_todo_loc" + todo_list_index)
                const element = document.createElement("div");
                element.innerText = object.todo + "\n" + object.date;
                const element_id = "todo" + todo_index + "loc"+todo_list_index;
                element.setAttribute('id', element_id);
                todo_index += 1
                location.appendChild(element);

                const button = document.createElement("button");
                button.innerText = "Done";
                button.id = element_id;
                button.onclick = display_remove_todo
                document.getElementById(element_id).appendChild(button);
            })
            todo_index = 0;
            todo_list_index += 1
        })
    }

    //Sorts the list in the parameter by date
    function display_todo_sort(list){
        list.sort(function (a,b){
            return a.date - b.date
        })
    }

    function display_remove_todo(){
        const targetLoc = event.target.id.split("loc")[1];
        const targetID = event.target.id;
        console.log(targetLoc);
        console.log(targetID);
        
        todo_list[targetLoc] = todo_list[targetLoc].filter(function (todo){
            if (String(todo.id) == String(targetID)){
                return false
            }
            else if (String(todo.id) != String(targetID)){
                return true
            }
        })
        console.log(todo_list[targetLoc]);

        save_data();
        display_render_todos();
    }
    </script>
</body>
</html>